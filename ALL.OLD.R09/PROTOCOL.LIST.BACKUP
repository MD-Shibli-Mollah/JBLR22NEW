********************************************************************
* PROGRAM : PROGRAM TO CREATE A LIST OF PROTOCOL APPLICATION
* DEV     : ALIN BOBY
* DATE    : 13.02.2017
* LIVE    : 14.02.2017
* REQ     : TEMENOS RECOMMENDED TO CLEAR PROTOCOL BEFORE COB PROCESS
*********************************************************************

    PROGRAM PROTOCOL.LIST.BACKUP

    $INSERT GLOBUS.BP I_COMMON
    $INSERT GLOBUS.BP I_EQUATE
    $INSERT GLOBUS.BP I_F.PROTOCOL
    $INSERT GLOBUS.BP I_ENQUIRY.COMMON

    GOSUB INIT
    GOSUB OPENFILES
    GOSUB PROCESS
    RETURN

INIT:

    FN.PROTOCOL = 'F.PROTOCOL'
    F.PROTOCOL = ''
    Y.ARR=''
    Y.CNT=''

    RETURN

OPENFILES:

    CALL OPF(FN.PROTOCOL,F.PROTOCOL)
    RETURN

PROCESS:

    Y.DDATE=OCONV(DATE(),'DYMD')
    Y.DTIME=OCONV(TIME(),"MTS")
    Y.DATETIME=EREPLACE(Y.DDATE,' ',''):"_":EREPLACE(Y.DTIME,':','')

    OPEN "PROTOCOL.BACKUP.DIR" TO F.PROTOCOL.BACKUP.DIR
    ELSE
        CMD = "CREATE.FILE PROTOCOL.BACKUP.DIR TYPE=UD"
        EXECUTE CMD
        OPEN "PROTOCOL.BACKUP.DIR" TO F.PROTOCOL.BACKUP.DIR
        ELSE
            CRT "OPENING OF PROTOCOL.BACKUP.DIR FAILED"
        END
    END
    Y.FILE.NAME = 'PROTOCOL':Y.DATETIME:'.csv'
    Y.FILE.DIR = 'PROTOCOL.BACKUP.DIR'
    Y.FILE.PATH = Y.FILE.DIR:'/':Y.FILE.NAME


    SEL.CMD="SELECT ":FN.PROTOCOL

    CALL EB.READLIST(SEL.CMD,RCC.IDS,'',PRO.REC.NO,PRO.RET.CODE)

    LOOP
        REMOVE PROT.REC FROM RCC.IDS SETTING ID.POS
    WHILE PROT.REC:ID.POS

        CALL F.READ(FN.PROTOCOL,PROT.REC,PROT.LIST,F.PROTOCOL,Y.CO.ERR)

        Y.PROCESS.DATE=PROT.LIST<EB.PTL.PROCESS.DATE>
        Y.DATE.VERSION=PROT.LIST<EB.PTL.DATE.VERSION>
        Y.PRO.TIME=PROT.LIST<EB.PTL.TIME>
        Y.PRO.TIME.MSEC=PROT.LIST<EB.PTL.TIME.MSECS>
        Y.PRO.TERMINAL.ID=PROT.LIST<EB.PTL.TERMINAL.ID>
        Y.PRO.PHANTOM.ID=PROT.LIST<EB.PTL.PHANTOM.ID>
        Y.PRO.COMPANY.ID=PROT.LIST<EB.PTL.COMPANY.ID>
        Y.PRO.USER=PROT.LIST<EB.PTL.USER>
        Y.PRO.APPLICATION=PROT.LIST<EB.PTL.APPLICATION>
        Y.PRO.LEVEL.FUNCTION=PROT.LIST<EB.PTL.LEVEL.FUNCTION>
        Y.PRO.ID=PROT.LIST<EB.PTL.ID>
        Y.PRO.REMARK=PROT.LIST<EB.PTL.REMARK>
        Y.PRO.CLIENT.IP.ADDRESS=PROT.LIST<EB.PTL.CLIENT.IP.ADDRESS>

        IF Y.PRO.USER NE '0' THEN
            Y.ARR<-1>=PROT.REC:'|':Y.PROCESS.DATE:'|':Y.DATE.VERSION:'|':Y.PRO.TIME:'|':Y.PRO.TIME.MSEC:'|':Y.PRO.TERMINAL.ID:'|':Y.PRO.PHANTOM.ID:'|':Y.PRO.COMPANY.ID:'|':Y.PRO.USER:'|':Y.PRO.APPLICATION:'|':Y.PRO.LEVEL.FUNCTION:'|':Y.PRO.ID:'|':Y.PRO.REMARK:'|':Y.PRO.CLIENT.IP.ADDRESS
            Y.CNT=Y.CNT+1
        END

        Y.PROCESS.DATE=''
        Y.DATE.VERSION=''
        Y.PRO.TIME=''
        Y.PRO.TIME.MSEC=''
        Y.PRO.TERMINAL.ID=''
        Y.PRO.PHANTOM.ID=''
        Y.PRO.COMPANY.ID=''
        Y.PRO.USER=''
        Y.PRO.APPLICATION=''
        Y.PRO.LEVEL.FUNCTION=''
        Y.PRO.ID=''
        Y.PRO.REMARK=''
        Y.PRO.CLIENT.IP.ADDRESS=''


    REPEAT

    IF NOT(Y.FILE.NAME) THEN
        CRT "NO FILE IS EXISTED, CREATING........."
    END
    ELSE
        WRITE Y.ARR TO F.PROTOCOL.BACKUP.DIR,Y.FILE.NAME
        CRT "COMPLETE! PLEASE CHECK THE DIRECTORY PROTOCOL.BACKUP.DIR"
        CRT "TOTAL RECORDS FOUND : ":Y.CNT
    END
    RETURN
END
