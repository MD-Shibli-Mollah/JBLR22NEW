*-----------------------------------------------------------------------------
* <Rating>699</Rating>
*-----------------------------------------------------------------------------
    SUBROUTINE JBL.TERM.LOAN.EXCISE.DUTY

    $INSERT GLOBUS.BP I_COMMON
    $INSERT GLOBUS.BP I_EQUATE
    $INSERT GLOBUS.BP I_F.ACCOUNT
    $INSERT JBL.BP I_F.ABL.H.LOAN.ED.CATEG
    $INSERT JBL.BP I_F.AB.H.ED.SLAB.PARAM
    $INSERT JBL.BP I_F.ABL.H.ED

    GOSUB INIT
    GOSUB OPENFILES
    GOSUB PROCESS
    RETURN

*-------
INIT:
*-------
    FN.ACCT = 'F.ACCOUNT'
    F.ACCT = ''

    FN.SLAB ='F.AB.H.ED.SLAB.PARAM'
    F.SLAB = ''
    Y.SLAB.ID ='SYSTEM'
    REC.SLAB = ''

    FN.ABL.ED ='F.ABL.H.ED'
    F.ABL.ED=''
    REC.ED=''

    FN.ED.CATEG='F.ABL.H.LOAN.ED.CATEG'
    F.ED.CATEG=''
    REC.ED.CATEG=''

    Y.ACCT.ID = ''
    Y.SLAB.COUNT = ''
    Y.EXCIXE.AMT = ''
    Y.SOURCE= "DM.OFS.SRC"
    Y.EXCISE.ACCT = ''
    CNT=''
    RETURN

*---------
OPENFILES:
*---------
    CALL OPF(FN.ACCT,F.ACCT)
    CALL OPF(FN.SLAB,F.SLAB)
    CALL OPF(FN.ABL.ED,F.ABL.ED)
    CALL OPF(FN.ED.CATEG,F.ED.CATEG)
    CALL GET.LOC.REF('ACCOUNT','PR.ASSET.CLASS',Y.PR.ASSET.CLASS.POS)
    RETURN

*--------
PROCESS:
*--------
    CALL F.READ(FN.SLAB,Y.SLAB.ID,REC.SLAB,F.SLAB,ERR.SLAB)
    Y.SLAB.COUNT = DCOUNT(REC.SLAB<EB.SL.PARAM.AMT.FROM>,VM)

    CALL F.READ(FN.ED.CATEG,'SYSTEM',REC.ED.CATEG,F.ED.CATEG,ERR.ED.CATEG)
    Y.INCLUDE.CATEG=REC.ED.CATEG<EXCS.LN.INC.OTHER.CATEG>
    Y.INCLUDE.COMPANY=REC.ED.CATEG<EXCS.LN.INCLUDE.COMP>
    Y.ST.MN.YR=REC.ED.CATEG<EXCS.LN.START.DATE>[1,6]
    Y.EN.MN.YR=REC.ED.CATEG<EXCS.LN.END.DATE>[1,6]
    Y.EXCISE.ACCT="BDT":REC.SLAB<EB.SL.PARAM.CATEGORY>:"0001"

    SEL.CMD.ACCT = "SELECT ":FN.ACCT:" WITH ( CATEGORY EQ "

    IF Y.INCLUDE.CATEG THEN
        CNT.EX.CATEG = DCOUNT(Y.INCLUDE.CATEG,VM)
        FOR I = 1 TO CNT.EX.CATEG
            IF I = CNT.EX.CATEG THEN
                SEL.CMD.ACCT := Y.INCLUDE.CATEG<1,I>
            END ELSE
                SEL.CMD.ACCT := Y.INCLUDE.CATEG<1,I>:" OR CATEGORY EQ "
            END
        NEXT I
    END

    SEL.CMD.ACCT=SEL.CMD.ACCT:" ) AND ( CO.CODE EQ "
    IF Y.INCLUDE.COMPANY THEN
        CNT.IN.COMP = DCOUNT(Y.INCLUDE.COMPANY,VM)
        FOR J = 1 TO CNT.IN.COMP
            IF J = CNT.IN.COMP THEN
                SEL.CMD.ACCT := Y.INCLUDE.COMPANY<1,J>
            END ELSE
                SEL.CMD.ACCT := Y.INCLUDE.COMPANY<1,J>:" OR CO.CODE EQ "
            END
        NEXT J
    END

    SEL.CMD.ACCT :=" ) AND EXCISE.WAIVE NE 'Waive'"

    CALL EB.READLIST(SEL.CMD.ACCT,SEL.LIST.ACCT,'',NO.OF.REC.AC,ERR.AC)
    CRT" TOTAL RECORDS SELECTED FOR FDR EXCISE DUTY......":NO.OF.REC.AC
    CRT" DO YOU WANT TO START THE PROCESSING OF EXCISE DUTY Y/N"
    INPUT USER.CHOICE

    IF USER.CHOICE EQ 'Y' THEN
        LOOP
            REMOVE  Y.ACCT.ID  FROM SEL.LIST.ACCT SETTING Y.ACCT.POS
        WHILE Y.ACCT.ID :Y.ACCT.POS

            CALL F.READ(FN.ACCT,Y.ACCT.ID,REC.ACCT,F.ACCT,ERR.ACCT)
            Y.PR.ASSET.CLASS = REC.ACCT<AC.LOCAL.REF,Y.PR.ASSET.CLASS.POS>

            IF Y.PR.ASSET.CLASS NE '50' THEN
                Y.START.PERIOD = Y.ST.MN.YR
                LOOP
                UNTIL Y.START.PERIOD GT Y.EN.MN.YR DO

                    CALL EB.GET.ACCT.ACTIVITY(Y.ACCT.ID,REC.ACCT,Y.START.PERIOD,BALANCE.TYPE,SYSTEM.DATE,R.ACCT.REC)
                    Y.AC.CO.CODE = REC.ACCT<AC.CO.CODE>
                    Y.MAX.AMT.TEMP=MAXIMUM(R.ACCT.REC<4>)
                    IF ABS(Y.MAX.AMT.TEMP) GT Y.MAX.AMT.ORIG THEN
                        Y.MAX.AMT.ORIG = ABS(Y.MAX.AMT.TEMP)
                        LOCATE Y.MAX.AMT.TEMP IN R.ACCT.REC<4,1> SETTING POS3 THEN
                            Y.MAX.DATE.ORIG=Y.START.PERIOD:R.ACCT.REC<1,POS3>
                        END
                    END
                    R.ACCT.REC=''
                    Y.MAX.AMT.TEMP=''
                    IF Y.START.PERIOD[5,2] EQ 12 THEN
                        Y.START.PERIOD = Y.START.PERIOD[1,4]+1:"01"
                    END
                    ELSE
                        Y.START.PERIOD = Y.START.PERIOD[1,4]:FMT(Y.START.PERIOD[5,2]+1,"R%2")
                    END
                REPEAT

                IF Y.MAX.AMT.ORIG GT 0 THEN
                    GOSUB RESULT.PROCESS
                END
                Y.START.PERIOD = ''
                Y.MAX.AMT.ORIG = ''
                Y.MAX.DATE.ORIG = ''
            END
        REPEAT
        RETURN
*---------------
RESULT.PROCESS:
*---------------
        FOR K=1 TO Y.SLAB.COUNT
            IF K NE Y.SLAB.COUNT THEN
                IF Y.MAX.AMT.ORIG GE REC.SLAB<EB.SL.PARAM.AMT.FROM,K> AND Y.MAX.AMT.ORIG LE REC.SLAB<EB.SL.PARAM.AMT.TO,K> THEN
                    Y.EXCIXE.AMT =REC.SLAB<EB.SL.PARAM.EX.DUTY.AMT,K>
                END
            END
            ELSE
                IF  Y.MAX.AMT.ORIG GE REC.SLAB<EB.SL.PARAM.AMT.FROM,K> THEN
                    Y.EXCIXE.AMT =REC.SLAB<EB.SL.PARAM.EX.DUTY.AMT,K>
                END
            END
        NEXT K

        PRINT"AC.ID = ":Y.ACCT.ID :" AMOUNT = ":Y.EXCIXE.AMT
        IF Y.EXCIXE.AMT GT 0 THEN
            Y.MESSAGE="FUNDS.TRANSFER,BANK.ED.CHRG/I/PROCESS,DMUSER.1//":Y.AC.CO.CODE:",,TRANSACTION.TYPE=ACED,DEBIT.ACCT.NO=":Y.ACCT.ID:",CREDIT.ACCT.NO=":Y.EXCISE.ACCT:",DEBIT.AMOUNT=":Y.EXCIXE.AMT:",DEBIT.CURRENCY=BDT,ORDERING.BANK=JBL,DR.ADVICE.REQD.Y.N=N,CR.ADVICE.REQD.Y.N=N"
*RUNNING.UNDER.BATCH=1
*CALL OFS.GLOBUS.MANAGER(Y.SOURCE,Y.MESSAGE)
*RUNNING.UNDER.BATCH=0
*SENSITIVITY=''

            OPTNS = ''
            MSG.ID = ''
            CALL OFS.POST.MESSAGE(Y.MESSAGE, MSG.ID , Y.SOURCE, OPTNS)
            CALL JOURNAL.UPDATE ('TEST')

            Y.STATUS =FIELD(FIELD(Y.MESSAGE,"/",3,1),",",1)
            Y.MESSAGE = ''
            IF Y.STATUS EQ 'PROCESS' THEN
                REC.ED<EXCS.DUT.HIGHEST.BAL.DATE>=Y.MAX.DATE.ORIG
                REC.ED<EXCS.DUT.HIGHEST.BAL.LCY>= Y.MAX.AMT.ORIG
                REC.ED<EXCS.DUT.EX.DUTY.AMT.LCY>= Y.EXCIXE.AMT
                REC.ED<EXCS.DUT.CO.CODE>=REC.ACCT<AC.CO.CODE>
                REC.ED<EXCS.DUT.TYPE>="CREDIT-TERM"
                WRITE REC.ED TO F.ABL.ED,Y.ACCT.ID:".":Y.EN.MN.YR
                CNT= CNT+1
                PRINT"PROCESS.... ":CNT
            END
        END
    END
    RETURN
END
