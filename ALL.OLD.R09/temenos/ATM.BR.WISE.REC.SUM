********************************************************************************
*THIS ROUTINE IS WRITTEN FOR COUNTING BRANCH WISE ATM CARD REQUEST
*AND STATUS (PENDING, APPROVED, DONE)
*Developed by: Muhammad Kamrul Hasan
*Date:22 MAR 2017
*********************************************************************************
!PROGRAM ATM.BR.WISE.REC.SUM
    SUBROUTINE ATM.BR.WISE.REC.SUM(Y.RETURN)
    $INSERT GLOBUS.BP I_COMMON
    $INSERT GLOBUS.BP I_EQUATE
    $INSERT GLOBUS.BP I_ENQUIRY.COMMON
    $INSERT BP I_F.ATM.CARD.MGT
    $INSERT GLOBUS.BP I_F.COMPANY

    GOSUB INIT
    GOSUB OPENFILES
    GOSUB PROCESS

INIT:
!    F.COMPANY="F.COMPANY"
    F.ATM.CARD.MGT="F.EB.ATM.CARD.MGT"
    F.PATH=""
    Y.CO.CODE=""
    Y.COMPANY.ENQ =""
    LOCATE "COMPANY.CODE" IN ENQ.SELECTION<2,1> SETTING COMP.POS THEN
        Y.COMPANY.ENQ  = ENQ.SELECTION<4,COMP.POS>
    END

    SEL.LIST=""
    NO.OF.REC=""
    Y.ERR=""
    Y.ID=""
    R.ATM=""
    SEL.LIST.ATM=""
    Y.CO.NAME=""
    Y.CO.CODE.ARR=""
    Y.CO.CODE.ARRN=""
    Y.COUNTS.CO=""
    Y.STATUS=""
    Y.PENDING=""
    Y.APPROVED=""
    Y.DONE=""
    RETURN

OPENFILES:
    CALL OPF(F.ATM.CARD.MGT,F.PATH)
    RETURN

PROCESS:
    IF  Y.COMPANY.ENQ EQ "" THEN
        SEL.CMD="SELECT ":F.ATM.CARD.MGT
    END
    ELSE
        SEL.CMD="SELECT ":F.ATM.CARD.MGT : " WITH CO.CODE EQ " : Y.COMPANY.ENQ
    END

    CALL EB.READLIST(SEL.CMD,SEL.LIST,"",NO.OF.REC,Y.ERR)

    LOOP
        REMOVE Y.ID FROM SEL.LIST SETTING POS
    WHILE Y.ID:POS

        CALL F.READ(F.ATM.CARD.MGT,Y.ID,R.ATM,F.PATH,Y.ERR) 

        Y.STATUS=R.ATM<EB.ATM19.CARD.STATUS> 

        IF Y.CO.CODE.ARR="" THEN
            Y.CO.CODE.ARR=R.ATM<EB.ATM19.CO.CODE>:SUBSTRINGS(Y.STATUS,1,2)
        END ELSE
            Y.CO.CODE.ARR=Y.CO.CODE.ARR:@FM:R.ATM<EB.ATM19.CO.CODE>:SUBSTRINGS(Y.STATUS,1,2)
        END


        Y.COUNTS.CO=COUNT(Y.CO.CODE.ARRN,R.ATM<EB.ATM19.CO.CODE>)
        IF Y.COUNTS.CO EQ 0 THEN
            IF Y.CO.CODE.ARRN NE "" THEN
                Y.CO.CODE.ARRN=Y.CO.CODE.ARRN:@FM:R.ATM<EB.ATM19.CO.CODE>

            END ELSE
                Y.CO.CODE.ARRN=R.ATM<EB.ATM19.CO.CODE>
            END
        END

    REPEAT

    LOOP
        REMOVE Y.ID FROM Y.CO.CODE.ARRN SETTING POS
    WHILE Y.ID:POS

        Y.PENDING=COUNT(Y.CO.CODE.ARR,Y.ID:"PE")
        Y.APPROVED=COUNT(Y.CO.CODE.ARR,Y.ID:"AP")
        Y.DONE=COUNT(Y.CO.CODE.ARR,Y.ID:"DO")
        Y.DENIED=COUNT(Y.CO.CODE.ARR,Y.ID:"DE")
        NO.OF.REC=Y.PENDING+Y.APPROVED+Y.DONE+Y.DENIED
!CRT Y.ID:"    ":NO.OF.REC:"   ":Y.PENDING:"      ":Y.APPROVED:"        ":Y.DONE :"      ":Y.DENIED
        Y.RETURN<-1>=Y.ID:"|":NO.OF.REC: "|":Y.PENDING:"|":Y.APPROVED:"|":Y.DONE :"|":Y.DENIED
    REPEAT
    Y.RETURN=SORT(Y.RETURN)
    RETURN
    !Y.RETURN=SORT(Y.RETURN)
    RETURN
END
