    SUBROUTINE JBL.ATM.BAT.TO.CSV(Y.RETURN)
!PROGRAM JBL.ATM.BAT.TO.CSV

    $INSERT GLOBUS.BP I_COMMON
    $INSERT GLOBUS.BP I_EQUATE
    $INSERT GLOBUS.BP I_ENQUIRY.COMMON
    $INSERT BP I_F.JBL.CARD.BATCH.CRE
    $INSERT BP I_F.ATM.CARD.MGT

!DEBUG
    FN.BATCH="F.JBL.CARD.BATCH.CRE"
    F.BATCH=""
    FN.ATM="F.EB.ATM.CARD.MGT"
    F.ATM=""

    CALL OPF(FN.BATCH,F.BATCH)
    CALL OPF(FN.ATM,F.ATM)

    LOCATE "ATTRIBUTE1" IN ENQ.SELECTION<2,1> SETTING REC.POS THEN
        Y.BATCH.NO = ENQ.SELECTION<4,REC.POS>
    END

!Y.BATCH.NO="BA20190120112842"

    CALL F.READ(FN.BATCH,Y.BATCH.NO,R.BATCH,F.BATCH,ERR1)
    Y.REQUEST.IDS=R.BATCH<CARD.BAT.REQUEST.ID>
    Y.REQUEST.TYPE=R.BATCH<CARD.BAT.REQUEST.TYPE>

    Y.COUNT= DCOUNT(Y.REQUEST.IDS, @VM)
    FOR I=1 TO Y.COUNT
        Y.RESULT= Y.REQUEST.IDS<1,I>
        CALL F.READ(FN.ATM,Y.RESULT,R.CARD,F.ATM,ERR2)
        IF R.CARD<EB.ATM19.CARD.STATUS> EQ "PENDING" AND Y.REQUEST.TYPE EQ R.CARD<EB.ATM19.REQUEST.TYPE> THEN
            Y.RETURN<-1>= Y.RESULT
        END
    NEXT I

    RETURN
