*-----------------------------------------------------------------------------
* <Rating>246</Rating>
*-----------------------------------------------------------------------------
    SUBROUTINE JBL.EXCISE.DUTY.RPT(Y.DATA)
!PROGRAM JBL.EXCISE.DUTY.RPT
    $INSERT GLOBUS.BP I_COMMON
    $INSERT GLOBUS.BP I_EQUATE
    $INSERT JBL.BP I_F.ABL.H.ED
    $INSERT GLOBUS.BP I_ENQUIRY.COMMON
    $INSERT GLOBUS.BP I_F.ACCOUNT
    $INSERT GLOBUS.BP I_F.CATEGORY

    GOSUB INIT
    GOSUB OPENFILES
    GOSUB PROCESS
    RETURN
INIT:
    FN.ABL.H.ED='FBNK.ABL.H.ED'
    F.ABL.H.ED=''
    R.ABL.H.ED=''
    Y.ABL.H.ED.ID=''
    Y.ERROR.ABL.H.ED=''
    FN.ACCOUNT='FBNK.ACCOUNT'
    F.ACCOUNT=''
    R.ACCOUNT=''
    Y.ACC.CATEG=''
    Y.ERROR.ACCOUNT=''
    FN.CATEGORY='F.CATEGORY'
    F.CATEGORY=''
    R.ACCOUNT=''
    Y.ERROR.CATEGORY=''
    Y.ID.COMPANY=ID.COMPANY
    Y.ACC.CNT=0
    Y.LIQ.AMT =0
    RETURN

OPENFILES:
    CALL OPF(FN.ABL.H.ED,F.ABL.H.ED)
    CALL OPF(FN.ACCOUNT,F.ACCOUNT)
    CALL OPF(FN.CATEGORY,F.CATEGORY)
    RETURN

PROCESS:

    LOCATE 'CATEGORY.CODE' IN ENQ.SELECTION<2,1> SETTING CAT.POS THEN
        Y.ACC.CATEG =  ENQ.SELECTION<4,CAT.POS>
    END
    SEL.CMD='SELECT ':FN.ABL.H.ED:' WITH CO.CODE EQ ':Y.ID.COMPANY:' AND @ID LIKE ...':TODAY[1,4]:'12'
    CALL EB.READLIST(SEL.CMD,SEL.LIST,'',NO.OF.REC,RET.CODE)
    LOOP
        REMOVE  Y.ABL.H.ED.ID FROM SEL.LIST SETTING Y.POS
    WHILE Y.ABL.H.ED.ID:Y.POS

        CALL F.READ(FN.ABL.H.ED,Y.ABL.H.ED.ID,R.ABL.H.ED,F.ABL.H.ED,Y.ERROR.ABL.H.ED)

        CALL F.READ(FN.ACCOUNT,FIELD(Y.ABL.H.ED.ID,".",1),R.ACCOUNT,F.ACCOUNT,Y.ERROR.ACCOUNT)
        Y.CATEGORY = R.ACCOUNT<AC.CATEGORY>
        Y.LIQ.ID = R.ACCOUNT<AC.INTEREST.LIQU.ACCT>

!CALL F.READ(FN.CATEGORY,Y.CATEGORY,R.CATEGORY,F.CATEGORY,Y.ERROR.CATEGORY)
!Y.CATEG.DESCRIPTION=R.CATEGORY<EB.CAT.DESCRIPTION>

        IF(Y.ACC.CATEG EQ Y.CATEGORY) THEN
            CALL F.READ(FN.CATEGORY,Y.CATEGORY,R.CATEGORY,F.CATEGORY,Y.ERROR.CATEGORY)
            Y.CATEG.DESCRIPTION=R.CATEGORY<EB.CAT.DESCRIPTION>

            Y.LEGACY.ID = R.ACCOUNT<AC.ALT.ACCT.ID>
            Y.TITLE = R.ACCOUNT<AC.SHORT.TITLE>
            IF Y.LIQ.ID NE "" THEN
                CALL F.READ(FN.ACCOUNT,Y.LIQ.ID,R.LIQ,F.ACCOUNT,ERR.AC)
                Y.LIQ.AMT = R.LIQ<AC.WORKING.BALANCE>
            END
            Y.WORKING.BALANCE1 = R.ACCOUNT<AC.WORKING.BALANCE>
            Y.WORKING.BALANCE = Y.WORKING.BALANCE1 + Y.LIQ.AMT
            Y.MAX.LIQ.BAL = R.ABL.H.ED<EXCS.DUT.LIQ.HIG.BAL.LCY>
            Y.MAX.BALANCE1 = R.ABL.H.ED<EXCS.DUT.HIGHEST.BAL.LCY>
            Y.MAX.BALANCE = Y.MAX.BALANCE1 + Y.MAX.LIQ.BAL
            Y.EXCISE.AMOUNT=R.ABL.H.ED<EXCS.DUT.EX.DUTY.AMT.LCY>
            Y.ACC.ID = FIELD(Y.ABL.H.ED.ID,".",1)
            Y.ACC.CNT +=1
        END
        ELSE
            IF Y.ACC.CATEG EQ '' THEN
                Y.LEGACY.ID = R.ACCOUNT<AC.ALT.ACCT.ID>
                Y.TITLE = R.ACCOUNT<AC.SHORT.TITLE>
                IF Y.LIQ.ID NE "" THEN
                    CALL F.READ(FN.ACCOUNT,Y.LIQ.ID,R.LIQ,F.ACCOUNT,ERR.AC)
                    Y.LIQ.AMT = R.LIQ<AC.WORKING.BALANCE>
                END
                Y.WORKING.BALANCE1 = R.ACCOUNT<AC.WORKING.BALANCE>
                Y.WORKING.BALANCE = Y.WORKING.BALANCE1 + Y.LIQ.AMT
!Y.WORKING.BALANCE = R.ACCOUNT<AC.WORKING.BALANCE>
                Y.MAX.LIQ.BAL = R.ABL.H.ED<EXCS.DUT.LIQ.HIG.BAL.LCY>
                Y.MAX.BALANCE1 = R.ABL.H.ED<EXCS.DUT.HIGHEST.BAL.LCY>
                Y.MAX.BALANCE = Y.MAX.BALANCE1 + Y.MAX.LIQ.BAL
!Y.MAX.BALANCE = R.ABL.H.ED<EXCS.DUT.HIGHEST.BAL.LCY>
                Y.EXCISE.AMOUNT=R.ABL.H.ED<EXCS.DUT.EX.DUTY.AMT.LCY>
                Y.ACC.ID = FIELD(Y.ABL.H.ED.ID,".",1)
                Y.ACC.CNT +=1
                Y.CATEGORY = ''
            END
        END
        IF(Y.ACC.CATEG EQ Y.CATEGORY) OR (Y.ACC.CATEG EQ '') THEN
            Y.DATA<-1>=Y.ACC.ID:'*':Y.LEGACY.ID:'*':Y.TITLE:'*':Y.MAX.BALANCE:'*':Y.EXCISE.AMOUNT:'*':Y.WORKING.BALANCE:'*':Y.CATEGORY:'*':Y.CATEG.DESCRIPTION:'*':Y.ACC.CNT
!                      1             2             3                4                5                      6                   7                      8                 9
        END
    REPEAT
!CRT Y.TOT.EXC.AMT:'*':Y.ACC.CNT

    RETURN
