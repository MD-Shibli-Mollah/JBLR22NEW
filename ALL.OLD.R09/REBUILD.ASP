*-----------------------------------------------------------------------------
* <Rating>759</Rating>
*-----------------------------------------------------------------------------
SUBROUTINE REBUILD.ASP

$INSERT I_COMMON
$INSERT I_EQUATE
$INSERT I_BATCH.FILES
$INSERT I_F.ACCOUNT
$INSERT I_F.ACCOUNT.STATEMENT
$INSERT I_F.STMT.ENTRY
$INSERT I_F.DATES

EXECUTE 'COMO ON REBUILD.ASP'

GOSUB INITIALISE
GOSUB MAIN.PROCESS

EXECUTE 'COMO OFF'

RETURN

*==========
INITIALISE:
*==========

FN.ACC = "F.ACCOUNT"
F.ACC = ""
CALL OPF(FN.ACC,F.ACC)

FN.SP = "F.STMT.PRINTED"
F.SP = ""
CALL OPF(FN.SP,F.SP)

FN.ASP = "F.ACCT.STMT.PRINT"
F.ASP = ""
CALL OPF(FN.ASP,F.ASP)

FN.SE = "F.STMT.ENTRY"
F.SE = ""
CALL OPF(FN.SE,F.SE)

FN.AS = "F.ACCOUNT.STATEMENT"
F.AS = ""
CALL OPF(FN.AS,F.AS)

MNE.ID = FN.SE[2,3]

OPEN '&SAVEDLISTS&' TO SAVE.LIST ELSE STOP

RETURN

*============
MAIN.PROCESS:
*============

R.ACC = ''; ASP.ID ='' ; ASP.IDS = '' ; ASP.CNT = ''
SEL.CMD = "GET.LIST CORR.ACC"
CALL EB.READLIST(SEL.CMD,ASP.IDS,'',ASP.CNT,ASP.ERR)
FOR K=1 TO ASP.CNT
ASP.ID = ASP.IDS<K>
IF ASP.ID THEN
READ R.ACC FROM F.ACC,ASP.ID THEN
PRINT "Processing ACCOUNT : ":ASP.ID
GOSUB CORRECT.PRINTED.ACCOUNTS
END ELSE
PRINT 'Missing ACCOUNT : ':ASP.ID
STOP
END
END
NEXT K
RETURN

*========================
CORRECT.PRINTED.ACCOUNTS:
*========================

ASP.REC = "" ; R.AS = ""
READ ASP.REC FROM F.ASP,ASP.ID ELSE ASP.REC = ""
READ R.AS FROM F.AS,ASP.ID ELSE R.AS = ""
STMT.DATES = FIELDS(ASP.REC,"/",1,1)
STMT.BALS = FIELDS(ASP.REC,"/",2,1)
NEXT.DATE.NO = DCOUNT(STMT.DATES,FM)
GOSUB INIT.STMT.BALS
FOR I = 1 TO NEXT.DATE.NO
SP.DATE = STMT.DATES<I>
IF SP.DATE GE TODAY THEN GOTO 100 ;* Do not calculate closing bal for the frequency scheduled for printing
SP.ID = ASP.ID:"-":SP.DATE
READ SP.REC FROM F.SP,SP.ID ELSE SP.REC = ""
CNT.STMT = DCOUNT(SP.REC,@FM)
SET.UPDATE = ""
STMT.BAL = ""
FOR X = 1 TO CNT.STMT
STMT.ID = SP.REC<X>
READ R.SE FROM F.SE,STMT.ID ELSE R.SE = ""
IF R.SE<AC.STE.AMOUNT.FCY> THEN
STMT.BAL += R.SE<AC.STE.AMOUNT.FCY>
END ELSE
STMT.BAL += R.SE<AC.STE.AMOUNT.LCY>
END
NEXT X

OP.BAL = 0
IF STMT.BALS<I> THEN OP.BAL = STMT.BALS<I>
NEXT.FREQ = "" ; NEXT.FREQ.BAL = ""
NEXT.FREQ.BAL = OP.BAL + STMT.BAL
NEXT.FREQ = STMT.DATES<I+1>
IF NEXT.FREQ = "" THEN
R.AS<AC.STA.FQU1.LAST.BALANCE> = NEXT.FREQ.BAL
WRITE R.AS TO F.AS,ASP.ID
END ELSE
IF NEXT.FREQ LT TODAY THEN
STMT.BALS<I+1> = NEXT.FREQ.BAL
END ELSE
STMT.BALS<I+1> = NEXT.FREQ.BAL
R.AS<AC.STA.FQU1.LAST.BALANCE> = NEXT.FREQ.BAL
WRITE R.AS TO F.AS,ASP.ID
END
END

100: NEXT I

IF ASP.REC THEN
ASP.REC = SPLICE(STMT.DATES, "/", STMT.BALS)
WRITE ASP.REC TO F.ASP,ASP.ID
END

RETURN
*==============
INIT.STMT.BALS:
*==============
STMT.BAL = 0
FOR J = 1 TO NEXT.DATE.NO
STMT.BALS<J> = 0
NEXT J

RETURN


END
*****************
