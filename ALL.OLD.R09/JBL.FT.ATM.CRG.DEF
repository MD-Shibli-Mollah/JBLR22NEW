*-----------------------------------------------------------------------------
* THIS ROUTINE USE FUNDS TRANSFER FOR ASSIGN CHARGE TYPE AND AMOUNT

*Deploy Date: 12 JAN 2019
*-----------------------------------------------------------------------------
    SUBROUTINE JBL.FT.ATM.CRG.DEF
!PROGRAM JBL.FT.ATM.CRG.DEF

    $INSERT GLOBUS.BP I_COMMON
    $INSERT GLOBUS.BP I_EQUATE
    $INSERT GLOBUS.BP I_F.ACCOUNT
    $INSERT BP I_F.ATM.CARD.MGT
    $INSERT GLOBUS.BP I_F.FUNDS.TRANSFER
    $INSERT BP I_F.JBL.ATM.MAINT.CALC
    $INCLUDE BP I_F.JBL.CARD.OFF.INFO

    FN.ATM.NAU="F.EB.ATM.CARD.MGT$NAU"
    F.ATM.NAU=""
    FN.FT = "F.FUNDS.TRANSFER"
    F.FT = ""
    FN.FT.NAU = "F.FUNDS.TRANSFER$NAU"
    F.FT.NAU = ""
    FN.JBL.ATM='F.JBL.ATM.MAINT.CALC'
    F.JBL.ATM=''
    FN.ACC='F.ACCOUNT'
    F.ACC=''
    FN.CARD.OFF = "F.JBL.CARD.OFF.INFO"
    F.CARD.OFF = ""

    CALL OPF(FN.FT,F.FT)
    CALL OPF(FN.ATM.NAU,F.ATM.NAU)
    CALL OPF(FN.JBL.ATM,F.JBL.ATM)
    CALL OPF(FN.ACC,F.ACC)
    CALL OPF(FN.FT.NAU,F.FT.NAU)
    CALL OPF(FN.CARD.OFF,F.CARD.OFF)


    CALL F.READ(FN.FT.NAU,ID.NEW,REC.FT.CHK,F.FT.NAU,ERR.FT)
    IF REC.FT.CHK EQ "" THEN
        CALL F.READ(FN.FT,ID.NEW,REC.FT.CHK,F.FT,ERR.FT)
    END

    CALL GET.LOC.REF('FUNDS.TRANSFER','CARD.MRK.FT',Y.CARD.MRK.FT)
    Y.ATM.ID= R.NEW(FT.LOCAL.REF)<1,Y.CARD.MRK.FT>

    CALL F.READ(FN.ATM.NAU,Y.ATM.ID,R.ATM.REC,F.ATM.NAU,Y.ERR)
    Y.REQUEST.TYPE=R.ATM.REC<EB.ATM19.REQUEST.TYPE>
    Y.AC.ID=R.ATM.REC<EB.ATM19.ACCT.NO>

    CALL F.READ(FN.ACC,Y.AC.ID,REC.ACC,F.ACC,ERR.ACC)
    Y.CATEGORY=REC.ACC<AC.CATEGORY>

    CALL F.READ(FN.CARD.OFF,Y.AC.ID,REC.OPP,F.CARD.OFF,ERR.OPP)
    Y.CARD.OFFER.VAL=REC.OPP<JBL.CARD.OFF.CARD.OFFER>

    CALL F.READ(FN.JBL.ATM,Y.REQUEST.TYPE,REC.ATM.CHRG,F.JBL.ATM,ERR.CDSTD.HF)
    IF REC.ATM.CHRG EQ '' THEN
        ETEXT="There must be a record ": Y.REQUEST.TYPE :" in JBL.ATM.MAINT.CALC"
        CALL STORE.END.ERROR
        RETURN
    END


    Y.INCLUDE.CATEGORY=REC.ATM.CHRG<ATM.MAINT.INCLUDE.CATEGORY>

    FIND Y.CATEGORY IN Y.INCLUDE.CATEGORY SETTING Ap, Vp THEN
        Y.TRN.TYPE=REC.ATM.CHRG<ATM.MAINT.TRANSACTION.TYPE>
        Y.VEN.ACT=REC.ATM.CHRG<ATM.MAINT.VEN.ACCT,Vp>
        Y.VEN.AMT=REC.ATM.CHRG<ATM.MAINT.VEN.CHARGE.AMT,Vp>
        IF Y.CARD.OFFER.VAL NE "50Percent" THEN
            Y.CHRG.TYPE=REC.ATM.CHRG<ATM.MAINT.CHARGE.TYPE,Vp>
            Y.BR.CHRG.AMT=REC.ATM.CHRG<ATM.MAINT.BRANCH.CHARGE.AMT,Vp>
            Y.FT.COMM=REC.ATM.CHRG<ATM.MAINT.FT.COMM.TYPE,Vp>
            Y.FT.COM.AMT=REC.ATM.CHRG<ATM.MAINT.FT.COMM.AMT,Vp>
            Y.VAT.PER=REC.ATM.CHRG<ATM.MAINT.VAT.PERCENT,Vp>
        END
    END


    R.NEW(FT.TRANSACTION.TYPE)=Y.TRN.TYPE
    R.NEW(FT.CREDIT.ACCT.NO)=Y.VEN.ACT
    R.NEW(FT.DEBIT.AMOUNT)= Y.VEN.AMT
    R.NEW(FT.COMMISSION.CODE)="WAIVE"
    IF Y.FT.COM.AMT NE "" THEN
        R.NEW(FT.COMMISSION.CODE)="DEBIT PLUS CHARGES"
        R.NEW(FT.COMMISSION.TYPE)=Y.FT.COMM
        R.NEW(FT.COMMISSION.AMT)="BDT ":Y.FT.COM.AMT
    END

    IF Y.REQUEST.TYPE EQ "PINREISSUE" OR Y.REQUEST.TYPE EQ "CLOSE" THEN
        R.NEW(FT.COMMISSION.CODE)="DEBIT PLUS CHARGES"
        R.NEW(FT.COMMISSION.TYPE)=Y.FT.COMM
    END




    RETURN


